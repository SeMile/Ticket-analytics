{% extends "base.html" %}

{% block content %}
<!-- Loader (сохраняем старый функционал) -->
<div class="loader-overlay" id="loader">
    <div class="d-flex flex-column align-items-center justify-content-center h-100">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <div class="mt-3" id="loaderText">Загрузка данных...</div>
    </div>
</div>

<!-- Dashboard Content -->
<div id="dashboard">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Аналитика продаж билетов</h1>
    </div>

    <!-- Filters -->
    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="year" class="form-label">Год</label>
                    <select id="year" class="form-select">
                        <option value="all">Все годы</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="status" class="form-label">Статус оплаты</label>
                    <select id="status" class="form-select">
                        <option value="all">Все статусы</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button id="apply-filters" class="btn btn-primary w-100">Применить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards - Первая строка -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="card-subtitle text-muted mb-2">Комиссия системы</h6>
                    <h3 class="card-title" id="total-commission">0 ₽</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="card-subtitle text-muted mb-2">Агентское вознаграждение</h6>
                    <h3 class="card-title" id="total-agent">0 ₽</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="card-subtitle text-muted mb-2">Средний чек</h6>
                    <h3 class="card-title" id="avg-order">0 ₽</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards - Вторая строка -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="card-subtitle text-muted mb-2">Общая выручка</h6>
                    <h3 class="card-title" id="total-revenue">0 ₽</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="card-subtitle text-muted mb-2">Всего возвратов</h6>
                    <h3 class="card-title" id="total-refunds">0 ₽</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100 shadow-sm">
                <div class="card-body">
                    <h6 class="card-subtitle text-muted mb-2">Средний чек возврата</h6>
                    <h3 class="card-title" id="avg-refund">0 ₽</h3>
                </div>
            </div>
        </div>
    </div>

    <!-- Топ продавцов -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-white">
            <h5 class="card-title mb-0">Топ-20 продавцов по вознаграждению</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="topSellersTable">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Компания-продавец</th>
                            <th>Агентское вознаграждение</th>
                            <th>Комиссия системы</th>
                            <th>Доля от общего вознаграждения</th>
                            <th>Количество заказов</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Графики -->
    <div class="row mb-4">
        <div class="col-12 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Динамика агентского вознаграждения по месяцам</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="agentTrend"></canvas>
                    </div>
                    <div class="forecast-info mt-2" id="agentForecastInfo"></div>
                </div>
            </div>
        </div>
        <div class="col-12 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Динамика комиссии системы по месяцам</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="commissionTrend"></canvas>
                    </div>
                    <div class="forecast-info mt-2" id="commissionForecastInfo"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Все агенты -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-white">
            <h5 class="card-title mb-0">Рейтинг всех агентов за весь период</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="allAgentsTable">
                    <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Компания-продавец</th>
                            <th>Агентское вознаграждение</th>
                            <th>Комиссия системы</th>
                            <th>Заказы</th>
                            <th>Билеты</th>
                            <th>Общая выручка</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Дополнительные блоки (сохраняем оригинальные ID) -->
    <div class="row">
        <div class="col-12">
            <div class="card mb-4 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Прямые продажи (без агентского вознаграждения)</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="directSalesTable">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Компания-продавец</th>
                                    <th>Прямые продажи</th>
                                    <th>Комиссия системы</th>
                                    <th>Доля от общих прямых продаж</th>
                                    <th>Количество заказов</th>
                                    <th>Общая выручка</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Сегментация по времени -->
    <div class="row">
        <div class="col-md-12 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Сегментация по времени оформления заказов</h5>
                </div>
                <div class="card-body">
                    <div class="time-segments-container" id="booking-segments-container"></div>
                </div>
            </div>
        </div>
	</div>
	<div class="row">
        <div class="col-md-12 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">
                    <h5 class="card-title mb-0">Сегментация по времени рейсов</h5>
                </div>
                <div class="card-body">
                    <div class="time-segments-container" id="flight-segments-container"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}