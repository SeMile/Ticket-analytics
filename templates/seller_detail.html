{% extends "base.html" %}

{% block content %}
<div class="loader-overlay" id="loader">
    <div class="d-flex flex-column align-items-center justify-content-center h-100">
        <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
        <div class="mt-3">Загрузка данных...</div>
    </div>
</div>

<div id="seller-dashboard">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">Аналитика продавца: {{ seller_name }}</h1>
            <a href="{{ url_for('dashboard') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Назад к дашборду
            </a>
        </div>
    </div>
	
	<div class="card mb-4 shadow-sm">
		<div class="card-body">
			<div class="row g-3">
				<div class="col-md-5">
					<label for="sellerYearFilter" class="form-label">Год</label>
					<select id="sellerYearFilter" class="form-select">
						<option value="all">Все годы</option>
						{% for year in available_years %}
						<option value="{{ year }}">{{ year }}</option>
						{% endfor %}
					</select>
				</div>
				<div class="col-md-5">
					<label for="sellerStatusFilter" class="form-label">Статус оплаты</label>
					<select id="sellerStatusFilter" class="form-select">
						<option value="all">Все статусы</option>
						<option value="Оплачен">Оплачен</option>
						<option value="Возвращен">Возвращен</option>
					</select>
				</div>
				<div class="col-md-2 d-flex align-items-end">
					<button id="applySellerFilters" class="btn btn-primary w-100">Применить</button>
				</div>
			</div>
		</div>
	</div>

    <!-- Summary Cards -->
    <div class="row mb-4">
		<div class="col-md-4 mb-4">
			<div class="card shadow-sm h-100">
				<div class="card-body">
					<h6 class="card-subtitle text-muted mb-2">Агентское вознаграждение</h6>
					<h3 class="card-title" id="seller-total-agent">{{ stats.total_agent|format_currency }}</h3>
				</div>
			</div>
		</div>
		<div class="col-md-4 mb-4">
			<div class="card shadow-sm h-100">
				<div class="card-body">
					<h6 class="card-subtitle text-muted mb-2">Комиссия системы</h6>
					<h3 class="card-title" id="seller-total-commission">{{ stats.total_commission|format_currency }}</h3>
				</div>
			</div>
		</div>
		<div class="col-md-4 mb-4">
			<div class="card shadow-sm h-100">
				<div class="card-body">
					<h6 class="card-subtitle text-muted mb-2">Средний чек</h6>
					<h3 class="card-title" id="seller-avg-order">{{ stats.avg_order|format_currency }}</h3>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card shadow-sm h-100">
				<div class="card-body">
					<h6 class="card-subtitle text-muted mb-2">Общая выручка</h6>
					<h3 class="card-title" id="seller-total-revenue">{{ stats.total_revenue|format_currency }}</h3>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card shadow-sm h-100">
				<div class="card-body">
					<h6 class="card-subtitle text-muted mb-2">Возвращено</h6>
					<h3 class="card-title" id="seller-total-refunds">{{ total_refunds|format_currency }}</h3>
				</div>
			</div>
		</div>
		<div class="col-md-4">
			<div class="card shadow-sm h-100">
				<div class="card-body">
					<h6 class="card-subtitle text-muted mb-2">Всего билетов</h6>
					<h3 class="card-title" id="seller-total-orders">{{ stats.total_orders }}</h3>
				</div>
			</div>
		</div>
    </div>
	
    <!-- График -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-white">
            <h5 class="card-title mb-0">Динамика продаж по месяцам</h5>
        </div>
        <div class="card-body">
            <div class="chart-container">
                <canvas id="salesTrend"></canvas>
            </div>
        </div>
    </div>
	
	<!-- Сравнение -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-white">
            <h5 class="card-title mb-0">Сравнение с другими продавцами</h5>
        </div>
        <div class="card-body">
            <div class="row g-3 mb-3">
                <div class="col-md-8">
                    <label for="compare-sellers" class="form-label">Выберите продавцов для сравнения:</label>
                    <select id="compare-sellers" class="form-select" multiple size="4">
                        {% for seller in all_sellers %}
                            <option value="{{ seller }}">{{ seller }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button id="compare-button" class="btn btn-primary w-100">Сравнить</button>
                </div>
            </div>
            <div id="comparison-results" class="mt-3"></div>
        </div>
    </div>
	
	<!-- Блок События -->
	<div class="card mb-4 shadow-sm">
		<div class="card-header bg-white">
			<h5 class="card-title mb-0">События продавца</h5>
		</div>
		<!-- Блок фильтров -->
			<div class="card-body">
				<form id="eventsFilterForm" method="get">
					<input type="hidden" name="name" value="{{ seller_name }}">
					<div class="row g-3">
						<div class="col-md-2">
							<label for="yearFilter" class="form-label">Год</label>
							<select id="yearFilter" name="year" class="form-select">
								<option value="all">Все годы</option>
								{% for year in available_years %}
								<option value="{{ year }}" {% if selected_year == year %}selected{% endif %}>{{ year }}</option>
								{% endfor %}
							</select>
						</div>
						<div class="col-md-8">
							<label for="eventsFilter" class="form-label">Название события</label>
							<select id="eventsFilter" name="events" class="form-select" multiple size="5">
								{% for event in available_events %}
								<option value="{{ event }}" {% if event in selected_events %}selected{% endif %}>{{ event }}</option>
								{% endfor %}
							</select>
						</div>
						<div class="col-md-2 d-flex align-items-end">
							<button type="submit" class="btn btn-primary w-100">Применить</button>
						</div>
					</div>
				</form>
			</div>
		<div class="card-body">
			<div class="table-responsive">
				<table class="table table-hover">
					<thead class="table-light">
						<tr>
							<th>Название события</th>
							<th>Билеты</th>
							<th>Комиссия агента</th>
							<th>Комиссия системы</th>
							<th>Общая выручка</th>
						</tr>
					</thead>
					<tbody>
						{% for event in seller_events %}
						<tr>
							<td>{{ event.event_name }}</td>
							<td>{{ event.tickets_count }}</td>
							<td>{{ event.agent_amount|format_currency }}</td>
							<td>{{ event.system_amount|format_currency }}</td>
							<td>{{ event.order_amount|format_currency }}</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<script>
    // Передаем ВСЕ данные для графика
    window.sellerChartData = {
        labels: {{ trend_labels|tojson|safe }},  // Все месяцы ["2020-01", "2020-02", ...]
        datasets: [{
            data: {{ trend_data|tojson|safe }}   // Все значения [1000, 1500, ...]
        }]
    };
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/seller_detail.js') }}"></script>
{% endblock %}